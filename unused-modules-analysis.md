# æœªä½¿ç”¨æ¨¡å—åˆ†ææŠ¥å‘Š

## ä¸€ã€å®Œå…¨æœªä½¿ç”¨çš„æ¨¡å—ï¼ˆå»ºè®®åˆ é™¤ï¼‰

### 1. DI å®¹å™¨ç³»ç»Ÿ
**è·¯å¾„**: `src-v2/core/di/`
- `Container.ts` - TSyringe å®¹å™¨å°è£…
- `decorators.ts` - è£…é¥°å™¨
- `types.ts` - DI ç±»å‹å®šä¹‰

**åŸå› **:
- âŒ åœ¨ `index.ts` ä¸­å®Œå…¨æ²¡æœ‰ä½¿ç”¨
- âŒ æ‰€æœ‰æœåŠ¡éƒ½æ˜¯ç›´æ¥ `new` åˆ›å»ºçš„
- âŒ MCP Server æ˜¯å•ä¾‹æ¨¡å¼ï¼Œä¸éœ€è¦å¤æ‚çš„ DI
- âŒ å¢åŠ äº†å­¦ä¹ æˆæœ¬å’Œå¤æ‚åº¦

**å»ºè®®**: **åˆ é™¤æ•´ä¸ªæ–‡ä»¶å¤¹**

---

### 2. ç©ºæ–‡ä»¶å¤¹
**è·¯å¾„**: 
- `src-v2/core/middleware/` - å®Œå…¨ä¸ºç©º
- `src-v2/monitoring/` - å®Œå…¨ä¸ºç©º  
- `src-v2/types/` - å®Œå…¨ä¸ºç©º
- `src-v2/core/server/` ä¸‹åº”è¯¥è¿˜æœ‰å…¶ä»– Server ç±»ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰

**åŸå› **:
- âŒ ä»æœªå®ç°ä»»ä½•å†…å®¹
- âŒ æ¶æ„è§„åˆ’æ—¶é¢„ç•™çš„ï¼Œä½†å®é™…ä¸éœ€è¦

**å»ºè®®**: **åˆ é™¤è¿™äº›ç©ºæ–‡ä»¶å¤¹**

---

### 3. ä¼ è¾“ç®¡ç†å™¨
**è·¯å¾„**: `src-v2/transport/TransportManager.ts`

**åŸå› **:
- âŒ MCP Server ä¸€æ¬¡åªä½¿ç”¨ä¸€ä¸ªä¼ è¾“æ–¹å¼
- âŒ åœ¨ `index.ts` ä¸­ç›´æ¥ä½¿ç”¨ `StdioServerTransport`
- âŒ ä¸éœ€è¦ç®¡ç†å¤šä¸ªä¼ è¾“æ–¹å¼

**å»ºè®®**: **åˆ é™¤æ–‡ä»¶**

---

### 4. HTTP å’Œ WebSocket ä¼ è¾“
**è·¯å¾„**: 
- `src-v2/transport/HttpTransport.ts` - å·²åˆ é™¤
- `src-v2/transport/WebSocketTransport.ts.bak` - å·²å¤‡ä»½

**åŸå› **:
- âŒ ç”¨æˆ·åªéœ€è¦ stdio ä¼ è¾“
- âŒ å®ç°å¤æ‚ï¼Œæœ‰å¤§é‡ç±»å‹é”™è¯¯
- âŒ MCP ä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯ stdio

**å»ºè®®**: **åˆ é™¤å¤‡ä»½æ–‡ä»¶**

---

### 5. åè®®å±‚
**è·¯å¾„**: `src-v2/core/protocol/`
- `MessageValidator.ts` - JSON-RPC æ¶ˆæ¯éªŒè¯
- `ProtocolErrorHandler.ts` - åè®®é”™è¯¯å¤„ç†

**åŸå› **:
- âŒ MCP SDK å·²ç»å¤„ç†äº†æ‰€æœ‰åè®®éªŒè¯
- âŒ åœ¨ä»£ç ä¸­å®Œå…¨æ²¡æœ‰è°ƒç”¨
- âŒ é‡å¤å®ç°äº† SDK çš„åŠŸèƒ½

**å»ºè®®**: **åˆ é™¤æ•´ä¸ªæ–‡ä»¶å¤¹**

---

## äºŒã€å·²å®ç°ä½†æœªé›†æˆçš„æ¨¡å—ï¼ˆå¯ä»¥æš‚æ—¶ä¿ç•™ï¼‰

### 1. ä¸­é—´ä»¶ç³»ç»Ÿ
**è·¯å¾„**: `src-v2/middleware/`
- `MiddlewareChain.ts`
- `LoggingMiddleware.ts`
- `ErrorHandlingMiddleware.ts`
- `AuthenticationMiddleware.ts`
- `RateLimitMiddleware.ts`
- `CacheMiddleware.ts`
- `PerformanceMiddleware.ts`
- `SecurityMiddleware.ts`

**å½“å‰çŠ¶æ€**:
- âœ… ä»£ç å®ç°å®Œæ•´
- âŒ æ²¡æœ‰åœ¨è¯·æ±‚å¤„ç†æµç¨‹ä¸­ä½¿ç”¨
- âŒ `MCPServer.ts` ä¸­æ²¡æœ‰è°ƒç”¨ä¸­é—´ä»¶é“¾

**åŸå› **:
- MCP æ˜¯è¯·æ±‚-å“åº”æ¨¡å¼ï¼Œä¸æ˜¯ HTTP ä¸­é—´ä»¶æ¨¡å¼
- å¯ä»¥åœ¨å·¥å…·æ‰§è¡Œå‰åæ·»åŠ é’©å­ï¼Œä¸éœ€è¦å®Œæ•´çš„ä¸­é—´ä»¶é“¾

**å»ºè®®**: 
- **é€‰é¡¹ A**: åˆ é™¤ï¼ˆæ¨èï¼‰- å› ä¸ºä¸ç¬¦åˆ MCP çš„å·¥ä½œæ–¹å¼
- **é€‰é¡¹ B**: ä¿ç•™ - å¦‚æœæœªæ¥æƒ³åœ¨å·¥å…·æ‰§è¡Œæ—¶æ·»åŠ æ—¥å¿—ã€ç›‘æ§ç­‰

---

### 2. æ’ä»¶ç³»ç»Ÿ
**è·¯å¾„**: `src-v2/core/plugin/`
- `Plugin.ts`
- `PluginRegistry.ts`
- `PluginLoader.ts`

**å½“å‰çŠ¶æ€**:
- âœ… ä»£ç å®ç°å®Œæ•´
- âŒ åœ¨ `index.ts` ä¸­æ²¡æœ‰ä½¿ç”¨
- âŒ ç›´æ¥è°ƒç”¨ `registerAllTools()` è€Œä¸æ˜¯åŠ è½½æ’ä»¶

**åŸå› **:
- å½“å‰åªæœ‰ 3 ä¸ª"æ’ä»¶"ï¼ˆgitlab-mrã€gitlab-fileã€gitlab-code-reviewï¼‰
- è¿™ 3 ä¸ª"æ’ä»¶"æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸åº”è¯¥ä½œä¸ºå¯æ’æ‹”çš„æ’ä»¶
- å¢åŠ äº†å¤æ‚åº¦ä½†æ²¡æœ‰å¸¦æ¥çµæ´»æ€§

**å»ºè®®**:
- **é€‰é¡¹ A**: åˆ é™¤ï¼ˆæ¨èï¼‰- ç›´æ¥æ³¨å†Œå·¥å…·æ›´ç®€å•
- **é€‰é¡¹ B**: ä¿ç•™ - å¦‚æœæœªæ¥çœŸçš„éœ€è¦ç¬¬ä¸‰æ–¹æ’ä»¶æ‰©å±•

---

### 3. èƒ½åŠ›ç®¡ç†å™¨
**è·¯å¾„**: `src-v2/capabilities/CapabilityManager.ts`

**å½“å‰çŠ¶æ€**:
- âœ… ä»£ç å®ç°å®Œæ•´
- âŒ åœ¨ `index.ts` ä¸­ç›´æ¥ä½¿ç”¨ç‹¬ç«‹çš„ Registryï¼Œä¸æ˜¯é€šè¿‡ CapabilityManager

**åŸå› **:
- åªæ˜¯å¯¹ä¸‰ä¸ª Registry çš„ç®€å•å°è£…
- æ²¡æœ‰æä¾›é¢å¤–çš„åŠŸèƒ½

**å»ºè®®**: **åˆ é™¤** - ç›´æ¥ä½¿ç”¨ä¸‰ä¸ªç‹¬ç«‹çš„ Registry æ›´æ¸…æ™°

---

## ä¸‰ã€æ ¸å¿ƒæ¨¡å—ï¼ˆå¿…é¡»ä¿ç•™ï¼‰

### âœ… ä¼ è¾“å±‚
- `src-v2/transport/StdioTransport.ts` - **ä¿ç•™**ï¼ˆå”¯ä¸€ä½¿ç”¨çš„ä¼ è¾“æ–¹å¼ï¼‰
- `src-v2/transport/Transport.ts` - **ä¿ç•™**ï¼ˆåŸºç±»ï¼‰
- `src-v2/transport/types.ts` - **ä¿ç•™**ï¼ˆç±»å‹å®šä¹‰ï¼‰

### âœ… æ ¸å¿ƒæœåŠ¡å™¨
- `src-v2/core/server/MCPServer.ts` - **ä¿ç•™**ï¼ˆæ ¸å¿ƒï¼‰
- `src-v2/index.ts` - **ä¿ç•™**ï¼ˆå…¥å£ï¼‰

### âœ… èƒ½åŠ›å±‚
- `src-v2/capabilities/tools/` - **ä¿ç•™**ï¼ˆå·¥å…·æ³¨å†Œï¼‰
- `src-v2/capabilities/resources/` - **ä¿ç•™**ï¼ˆèµ„æºï¼‰
- `src-v2/capabilities/prompts/` - **ä¿ç•™**ï¼ˆæç¤ºï¼‰

### âœ… ä¸šåŠ¡å±‚
- `src-v2/services/` - **ä¿ç•™**ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
- `src-v2/repositories/` - **ä¿ç•™**ï¼ˆæ•°æ®è®¿é—®ï¼‰

### âœ… æ’ä»¶å®ç°
- `src-v2/plugins/gitlab-mr/` - **ä¿ç•™**ï¼ˆMR å·¥å…·ï¼‰
- `src-v2/plugins/gitlab-file/` - **ä¿ç•™**ï¼ˆæ–‡ä»¶å·¥å…·ï¼‰
- `src-v2/plugins/gitlab-code-review/` - **ä¿ç•™**ï¼ˆä»£ç å®¡æŸ¥ï¼‰

### âœ… åŸºç¡€è®¾æ–½
- `src-v2/config/` - **ä¿ç•™**ï¼ˆé…ç½®ç®¡ç†ï¼‰
- `src-v2/logging/` - **ä¿ç•™**ï¼ˆæ—¥å¿—ï¼‰
- `src-v2/errors/` - **ä¿ç•™**ï¼ˆé”™è¯¯å¤„ç†ï¼‰
- `src-v2/cache/` - **ä¿ç•™**ï¼ˆç¼“å­˜ï¼‰

### âœ… å·¥å…·
- `src-v2/utils/` - **ä¿ç•™**ï¼ˆå·¥å…·å‡½æ•°ï¼‰
- `src-v2/bootstrap/` - **ä¿ç•™**ï¼ˆå¯åŠ¨é€»è¾‘ï¼‰

---

## å››ã€åˆ é™¤å»ºè®®æ€»ç»“

### ğŸ”´ å¿…é¡»åˆ é™¤ï¼ˆå®Œå…¨æ²¡ç”¨ï¼‰
1. `src-v2/core/di/` - DI å®¹å™¨ç³»ç»Ÿ
2. `src-v2/core/protocol/` - åè®®å±‚
3. `src-v2/core/middleware/` - ç©ºæ–‡ä»¶å¤¹
4. `src-v2/monitoring/` - ç©ºæ–‡ä»¶å¤¹
5. `src-v2/types/` - ç©ºæ–‡ä»¶å¤¹
6. `src-v2/transport/TransportManager.ts` - ä¼ è¾“ç®¡ç†å™¨
7. `src-v2/transport/WebSocketTransport.ts.bak` - å¤‡ä»½æ–‡ä»¶
8. `src-v2/capabilities/CapabilityManager.ts` - èƒ½åŠ›ç®¡ç†å™¨

### ğŸŸ¡ å¯ä»¥åˆ é™¤ï¼ˆå·²å®ç°ä½†æœªä½¿ç”¨ï¼‰
9. `src-v2/middleware/` - æ•´ä¸ªä¸­é—´ä»¶ç³»ç»Ÿï¼ˆ8ä¸ªæ–‡ä»¶ï¼‰
10. `src-v2/core/plugin/` - æ’ä»¶ç³»ç»Ÿï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

### âœ… å¿…é¡»ä¿ç•™
- æ‰€æœ‰ä¸šåŠ¡é€»è¾‘æ¨¡å—
- æ‰€æœ‰å·¥å…·å®ç°
- æ ¸å¿ƒæœåŠ¡å™¨å’Œä¼ è¾“å±‚

---

## äº”ã€åˆ é™¤åçš„æ”¶ç›Š

### ä»£ç é‡å‡å°‘
- åˆ é™¤çº¦ **2000+ è¡Œä»£ç **
- åˆ é™¤çº¦ **20 ä¸ªæ–‡ä»¶**

### å¤æ‚åº¦é™ä½
- ä¸éœ€è¦ç†è§£ DI å®¹å™¨
- ä¸éœ€è¦ç†è§£ä¸­é—´ä»¶é“¾
- ä¸éœ€è¦ç†è§£æ’ä»¶ç³»ç»Ÿ
- ä¸éœ€è¦ç†è§£å¤šä¼ è¾“æ–¹å¼ç®¡ç†

### ç¼–è¯‘é”™è¯¯å‡å°‘
- åˆ é™¤ DI ç›¸å…³çš„ç±»å‹é”™è¯¯ï¼ˆçº¦ 5 ä¸ªï¼‰
- åˆ é™¤ä¸­é—´ä»¶ç›¸å…³çš„ç±»å‹é”™è¯¯ï¼ˆçº¦ 10 ä¸ªï¼‰
- åˆ é™¤åè®®å±‚çš„ç±»å‹é”™è¯¯ï¼ˆçº¦ 2 ä¸ªï¼‰

### ç»´æŠ¤æˆæœ¬é™ä½
- ä»£ç æ›´ç®€å•ã€æ›´ç›´æ¥
- æ›´å®¹æ˜“ç†è§£å’Œä¿®æ”¹
- ç¬¦åˆ KISS åŸåˆ™

---

## å…­ã€ç²¾ç®€åçš„æ¶æ„

```
src-v2/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ server/           # MCP Server æ ¸å¿ƒ
â”œâ”€â”€ transport/            # åªä¿ç•™ stdio
â”‚   â”œâ”€â”€ Transport.ts
â”‚   â”œâ”€â”€ StdioTransport.ts
â”‚   â””â”€â”€ types.ts
â”œâ”€â”€ capabilities/         # èƒ½åŠ›å±‚ï¼ˆå·¥å…·ã€èµ„æºã€æç¤ºï¼‰
â”œâ”€â”€ services/             # ä¸šåŠ¡å±‚
â”œâ”€â”€ repositories/         # æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ plugins/              # å·¥å…·å®ç°ï¼ˆä¸æ˜¯çœŸæ­£çš„æ’ä»¶ç³»ç»Ÿï¼‰
â”œâ”€â”€ config/               # é…ç½®
â”œâ”€â”€ logging/              # æ—¥å¿—
â”œâ”€â”€ errors/               # é”™è¯¯å¤„ç†
â”œâ”€â”€ cache/                # ç¼“å­˜
â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°
â”œâ”€â”€ bootstrap/            # å¯åŠ¨é€»è¾‘
â””â”€â”€ index.ts              # å…¥å£
```

**å±‚çº§**: 4 å±‚ï¼ˆè€Œä¸æ˜¯ 6 å±‚ï¼‰
1. **ä¼ è¾“å±‚**: stdio
2. **ä¸šåŠ¡å±‚**: Services
3. **æ•°æ®è®¿é—®å±‚**: Repositories
4. **å·¥å…·å±‚**: Tools/Resources/Prompts

---

## ä¸ƒã€æ‰§è¡Œè®¡åˆ’

1. **ç«‹å³åˆ é™¤**:
   - ç©ºæ–‡ä»¶å¤¹å’Œå®Œå…¨æœªä½¿ç”¨çš„æ¨¡å—
   - å‡å°‘ç¼–è¯‘é”™è¯¯

2. **æš‚æ—¶ä¿ç•™**:
   - ä¸­é—´ä»¶ç³»ç»Ÿï¼ˆå¦‚æœæœªæ¥éœ€è¦æ·»åŠ æ—¥å¿—ã€ç›‘æ§ï¼‰
   - æ’ä»¶ç³»ç»Ÿï¼ˆå¦‚æœæœªæ¥éœ€è¦ç¬¬ä¸‰æ–¹æ‰©å±•ï¼‰

3. **åç»­ä¼˜åŒ–**:
   - è¯„ä¼°ä¸­é—´ä»¶å’Œæ’ä»¶ç³»ç»Ÿçš„å®é™…éœ€æ±‚
   - å¦‚æœ 2 å‘¨å†…æ²¡æœ‰ç”¨åˆ°ï¼Œå°±åˆ é™¤

